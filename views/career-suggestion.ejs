<%- layout('layouts/boilerplate') %>

<head>
  <title>Terzetto AI Chatbot</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Include Marked.js from a CDN to parse markdown to HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* Chat container styling */

    #chat-container {
      width: 100%;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      height: 86vh;
    }

    /* Messages container */
    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Welcome screen for no messages */
    #welcome {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #6c757d;
    }

    #welcome img {
      max-width: 200px;
      opacity: 0.95;
    }

    /* Input area */
    #input {
      padding: 15px;
      background: #f1f3f5;
    }

    /* Message styling: width set to 80% */
    .user-message,
    .bot-message {
      width: fit-content;
      max-width: 80%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }


    .user-message {
      background-color: #d1e7dd;
      /* align-self: flex-end; */
      justify-content: flex-end;
      margin-left: auto;

    }

    .bot-message {
      background-color: #cff4fc;
      /* align-self: flex-start; */
      justify-content: flex-start;

    }

    .typing {
      display: none;
      font-style: italic;
      color: #6c757d;
      padding: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 10px;
    }
  </style>
</head>

<body>
  <div id="chat-container" >
    <!-- Header -->
    <div class="text-white text-center p-3">
      <h3 class="mb-0 text-muted fw-bold">
        Start Chatting with Terzetto AI
      </h3>
    </div>

    <!-- Chat messages -->
    <div id="messages">
      <!-- Welcome screen (visible when no messages have been sent) -->
      <div id="welcome">
        <img src="/images/image.png" alt="Welcome" class="img-fluid" />
        <p class="mt-3">
          <%= user.username.toUpperCase() %>, How can I help you today?
        </p>
      </div>
    </div>

    <!-- Typing indicator -->
    <div id="typingIndicator" class="typing">
      Terzetto AI is typing...
    </div>

    <!-- Input area -->
    <div id="input" class="d-flex">
      <input type="text" id="userInput" class="form-control" placeholder="Type your message..." />
      <button class="btn btn-primary ms-2 mb-0" onclick="sendMessage()">
        Send
      </button>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Function to send a message
    async function sendMessage() {
      const userInputField = document.getElementById("userInput");
      const userInput = userInputField.value.trim();

      if (!userInput) return;

      // Remove the welcome screen if it exists
      const welcomeElement = document.getElementById("welcome");
      if (welcomeElement) {
        welcomeElement.remove();
      }

      const messagesContainer = document.getElementById("messages");

      // Append the user's message
      const userMessageDiv = document.createElement("div");
      userMessageDiv.className = "user-message";
      userMessageDiv.innerHTML = `
          <span>${userInput}</span>
          <img src="<%= user.photoUrl %>" class="avatar" alt="User Avatar">
        `;
      messagesContainer.appendChild(userMessageDiv);
      userInputField.value = "";

      // Auto-scroll to the latest message
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Show typing indicator
      const typingIndicator = document.getElementById("typingIndicator");
      typingIndicator.style.display = "block";

      try {
        // Post the message to your chat API
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userInput }),
        });

        const data = await response.json();

        // Hide typing indicator
        typingIndicator.style.display = "none";

        // Convert the Gemini API markdown response to HTML using Marked.js
        const botMessageHTML = marked.parse(data.response);

        // Append the bot's reply (now properly formatted)
        const botMessageDiv = document.createElement("div");
        botMessageDiv.className = "bot-message";
        botMessageDiv.innerHTML = `
            <img src="/images/WelcomeUser.png" class="avatar" alt="Bot Avatar">
            <span>${botMessageHTML}</span>
          `;
        messagesContainer.appendChild(botMessageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error("Error:", error);
        typingIndicator.style.display = "none";
      }
    }

    // Event listener for "Enter" key press
    document
      .getElementById("userInput")
      .addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      });
  </script>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>