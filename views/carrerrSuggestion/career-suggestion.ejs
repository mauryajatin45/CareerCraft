<%- layout('layouts/boilerplate') %>

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quad's AI Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
        #chat-container {
      width: 100%;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      height: 87vh;
    }

    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    #welcome {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #6c757d;
    }

    #welcome img {
      max-width: 200px;
      opacity: 0.95;
    }

    #input {
      padding: 15px;
      background: #f1f3f5;
    }

    .user-message,
    .bot-message {
      width: fit-content;
      max-width: 80%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }


    .user-message {
      background-color: #d1e7dd;
      /* align-self: flex-end; */
      justify-content: flex-end;
      margin-left: auto;

    }

    .bot-message {
      background-color: #cff4fc;
      /* align-self: flex-start; */
      justify-content: flex-start;

    }

    .typing {
      display: none;
      font-style: italic;
      color: #6c757d;
      padding: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 10px;
    }
  </style>
    </style>
  </head>
  <body>
    <div id="chat-container">
      <div class="text-center p-3 text-black bg-light border-bottom">
        <h3 class="mb-0">Start Chatting with Quad's AI</h3>
      </div>

      <div id="messages">
        <div id="welcome">
          <img src="/images/image.png" alt="Welcome" class="img-fluid" />
          <p class="mt-3">
            <%= user.name.toUpperCase() %>, how can I help you today?
          </p>
        </div>
      </div>

      <div id="typingIndicator" class="typing">
        Quad's AI is typing...
      </div>

      <div id="input" class="d-flex align-items-center">
        <select id="languageSelect" class="form-select me-2" style="width: 150px;">
          <option value="en" selected>English</option>
          <option value="hi">Hindi</option>
          <option value="gu">Gujarati</option>
          <option value="mr">Marathi</option>
          <option value="bho">Bhojpuri</option>
          <option value="np">Nepali</option>
        </select>
        <input
          type="text"
          id="userInput"
          class="form-control"
          placeholder="Type your message..."
        />
        <button class="btn btn-primary ms-2" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      async function sendMessage() {
        const userInputField = document.getElementById("userInput");
        const userInput = userInputField.value.trim();
        if (!userInput) return;

        const welcomeElement = document.getElementById("welcome");
        if (welcomeElement) welcomeElement.remove();

        const messagesContainer = document.getElementById("messages");

        const userMessageDiv = document.createElement("div");
        userMessageDiv.className = "user-message";
        userMessageDiv.innerHTML = `
          <span>${userInput}</span>
          <img src="/images/Logo.png" class="avatar" alt="User Avatar">
        `;
        messagesContainer.appendChild(userMessageDiv);
        userInputField.value = "";
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const languageSelect = document.getElementById("languageSelect");
        const selectedLanguage = languageSelect.value;

        const typingIndicator = document.getElementById("typingIndicator");
        typingIndicator.style.display = "block";

        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: userInput,
              language: selectedLanguage
            }),
          });
          const data = await response.json();
          typingIndicator.style.display = "none";

          const botMessageHTML = marked.parse(data.response);
          const botMessageDiv = document.createElement("div");
          botMessageDiv.className = "bot-message";
          botMessageDiv.innerHTML = `
            <img src="/images/image.png" class="avatar" alt="Bot Avatar">
            <span>${botMessageHTML}</span>
          `;
          messagesContainer.appendChild(botMessageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } catch (error) {
          console.error("Error:", error);
          typingIndicator.style.display = "none";
        }
      }

      document.getElementById("userInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
